colorscheme desertex

add-highlighter global/line-numbers number-lines -hlcursor
add-highlighter global/list-chars show-whitespaces \
  -tab '»' -tabpad '·' -nbsp '•' -spc ' ' -lf ' '

add-highlighter global/overlong-line dynregex \
  '^[^\n]{%opt{autowrap_column}}([^\n]+)' 1:Error

# default to 2-space indentation everywhere (override in individual filetypes)
set-option global indentwidth 2

# TODO: organize this better: full plugin? / autoload/ ?
define-command vim-star -docstring %{
  Make `*` in Kakoune work more like `*` in Vim.
  If there is only one selection
  ... and it is only one character
  ... then select the current word before running `*`.
} %{
  try %{
    execute-keys -draft '<a-space>'
  } catch %{
    try %{
      execute-keys -draft '<a-K>..<ret>'
      execute-keys '<a-i>w'
    }
  }
  execute-keys -save-regs '' '*'
}
map global normal '*' ': vim-star<ret>'

alias global h doc

## plug.kak plugins

declare-option -docstring 'Install plugins in ~/.local/kak by default' \
  str localkak %sh{echo "$HOME/.local/kak"}

source "%opt{localkak}/plugins/plug.kak/rc/plug.kak"
plug "andreyorst/plug.kak" noload
try %{ set-option global plug_install_dir "%opt{localkak}/plugins" }

plug "andreyorst/fzf.kak" defer 'fzf' %{
  map global normal <c-p> ': fzf-file<ret>' -docstring 'fzf = <Ctrl+p>'
  map global user b ': fzf-buffer<ret>' -docstring 'fzf buffer selection'
  map global user F ': fzf-mode<ret>' -docstring 'FZF mode'
  set-option global fzf_file_command 'rg'
}
try %{ require-module fzf } catch %{ echo -markup '{Error}fzf not installed' }

map -docstring 'insert case-insensitive flag for searching by default' global normal / '/(?i)'

hook global ModuleLoaded x11 %{
  set-option global termcmd 'term -e sh -c'
}

set-option global grepcmd 'rg --hidden --column'

hook global BufWritePost .* 'git show-diff'
hook global BufOpenFile .* 'git show-diff'
map global user 'd' ': git diff %val{buffile}<ret>'

eval %sh{kak-lsp --kakoune -s $kak_session}
# lsp-enable # TODO: enable per-filetype?

hook global WinSetOption filetype=elixir %{
  set-option buffer autowrap_column 98
}

hook global WinSetOption filetype=java %{
  set-option buffer autowrap_column 120
  set-option buffer indentwidth 4
}
