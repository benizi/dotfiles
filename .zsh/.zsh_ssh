FORCE=${SSH_FORCE:-false}
function ssh_find () {
	find ~/.ssh ! -name .ssh -type d -prune -o \
		-type f -name 'id_*' \
		! -name '*.pub' \
		! -name '*.ppk' \
		-print \
	| sort
}
function ssh_find_add () {
	if (( $+INSOL )) ; then
		ssh_find | env DISPLAY= xargs ssh-add
		return
	fi
	ssh_find \
	| perl -l0pe '' \
	| env -u DISPLAY xargs -0 ssh-add
}
function ssh_re_source () {
	[ -r ~/ssh-script ] && . ~/ssh-script > /dev/null
}
function ssh_restart () {
	ssh-agent > ~/ssh-script
	ssh_re_source
}
function ssh_script_regen () {
	cat > ~/ssh-script <<SSH
SSH_AUTH_SOCK=$SSH_AUTH_SOCK; export SSH_AUTH_SOCK;
SSH_AGENT_PID=$SSH_AGENT_PID; export SSH_AGENT_PID;
echo Agent pid $SSH_AGENT_PID;
SSH
}
if $FORCE || [[ -O ${(%):-"%N"} ]] ; then
	local _run=false
	ssh_re_source
	[ -z "$SSH_AGENT_PID" ] && _run=true
	$_run || kill -0 $SSH_AGENT_PID 2>/dev/null || _run=true
	$_run || [ -z "$INLIN" ] || grep -q ssh-agent /proc/$SSH_AGENT_PID/cmdline 2>/dev/null || _run=true
	$_run && ssh_restart
	ssh-add -l &> /dev/null
	[[ $? = 2 ]] && ssh_restart
	ssh-add -l | grep -vq no.identities || ssh_find_add
fi
