#!/usr/bin/env ruby
require 'optparse'
require 'ostruct'

NAMESPACE_TYPES = Dir["/proc/self/ns/*"].map { |f| File.basename(f).to_sym }

opts = OpenStruct.new(type: nil, pid: nil, file: nil)
OptionParser.new do |parser|
  [
    ['-p', '--pid', '=PID', Integer, 'Other PID'],
    ['-t', '--type', '=TYPE', NAMESPACE_TYPES, 'Namespace type'],
    ['-f', '--file', '=FILENAME', String, 'Full namespace filename'],
  ].each do |spec|
    setter = spec[1].sub(/^--/,'').sub(/$/,'=').to_sym
    parser.on(*spec, &opts.method(setter))
  end
end.parse!

unless opts.file or (opts.pid and opts.type)
  raise "Must specify either --file or (--pid and --type)"
end

opts.file ||= "/proc/#{opts.pid}/ns/#{opts.type}"

begin
  ns = File::open(opts.file)
rescue IOError => e
  warn "Failed to open #{opts.file}: #{e}"
  exit 1
end
syscall 308, ns.fileno, 0
[opts.pid, 'self', 1].each do |pid|
  target = File.readlink "/proc/#{pid}/ns/#{opts.type}"
  puts [target, pid].join(' ')
end
