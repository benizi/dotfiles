#!/usr/bin/env ruby
require 'fileutils'
require 'optparse'

abort unless system('dtach --version > /dev/null')

opts = {
	:mode => :new
}
parser = OptionParser.new do |o|
	o.on('-n') { opts[:mode] = :detach }
	o.on('-S NAME', '--name NAME') { |n| opts[:name] = n }
	o.on('--dir DIR') { |d| opts[:dir] = d }
	o.on('-r') { opts[:mode] = :resume }
	o.on('-R') { opts[:mode] = :resume_or_new }
	o.on('-l','-ls','--ls') { opts[:mode] = :list }
	o.on('--dry-run') { opts[:dry] = true }
end
parser.order!(ARGV)

opts[:dir] ||= ENV['DTACH_DIR']
opts[:dir] ||= ENV['HOME'] + '/.dtach'

FileUtils.mkdir_p(opts[:dir]) unless File.directory?(opts[:dir])

def socks(dir)
	ret = []
	Dir.new(dir).each do |f|
		next if %w{. ..}.include?(f)
		ret << f
	end
	ret.sort
end

def suffixed(dir, name, exist)
	name ||= ''
	name = name.gsub(/^.*\//,'')
	already = socks(dir).grep(/^#{name}\d{0,2}$/).sort
	return already[0] if exist
	ret = nil
	100.times do |i|
		testname = "#{name}"
		testname << i.to_s if i > 0
		next if testname.empty? or already.include?(testname)
		ret = testname
		break
	end
	ret
end

if opts[:mode] == :list
	me = ENV['DTACH'] ? ENV['DTACH'].split('/')[-1] : nil
	socks(opts[:dir]).each do |sock|
		print '*' if sock == me
		puts sock
	end
	exit
end

case opts[:mode]
when :resume, :resume_or_new
	opts[:name] ||= ARGV[0]
	opts[:name] = suffixed(opts[:dir], opts[:name], true)
	if opts[:mode] == :resume_or_new
		opts[:mode] = opts[:name] ? :resume : :new
	else
		abort "Nothing to resume" unless opts[:name]
	end
end

case opts[:mode]
when :new, :detach
	ARGV << (ENV['SHELL'] || 'bash') if ARGV.empty?
	opts[:name] = suffixed(opts[:dir], opts[:name] || ARGV[0], false)
end

sock = opts[:dir] + '/' + opts[:name]
abort "No such socket: #{sock}" if opts[:mode] == :resume and not File.exists?(sock)

cmd = ['dtach']
case opts[:mode]
when :resume ; cmd << '-a'
when :new ; cmd << '-A'
when :detach ; cmd << '-n'
end
cmd << sock

cmd += ARGV unless opts[:mode] == :resume

if ENV['DTACH'] and ENV['DTACH'] == sock and not opts[:force]
	abort "Already in dtach?"
end

if opts[:dry]
	puts <<INFO
DTACH=#{sock}
cmd=#{cmd.join(' ')}
INFO
	exit
end

ENV['DTACH'] = sock
exec(*cmd)
