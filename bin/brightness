#!/bin/sh

die() {
  printf 'Error: %s\n' "$*"
  exit 1
}

# use /sys/class/backlight to simulate `xbacklight`
setbacklight() {
  glob='/sys/class/backlight/*'
  op=$1 pct=$2
  set -- $glob
  if [ "$1" != "$glob" ] ; then
    bl=$1
    max="$(cat $bl/max_brightness)"
    cur="$(cat $bl/brightness)"
    delta=$(( pct * max / 100 ))

    case "$op" in
      (-get)
        printf '6 k %s 100 * %s / p\n' $cur $max | dc
        exit
        ;;
      ('=') val=$delta ;;
      (*) val=$(( cur $op delta )) ;;
    esac
    if [ -z "$val" ] || [ $val -lt 1 ] ; then
      die Not setting zero brightness
    fi
    echo $val | sudo sh -c "cat - > $bl/brightness"
  fi
}

case "$1" in
  (up) setbacklight + 10 ;;
  (down) setbacklight - 10 ;;
  (min) setbacklight '=' 10 ;;
  (max) setbacklight '=' 100 ;;
  ('='|set) setbacklight '=' $2 ;;
  (''|-get) setbacklight -get ;;
  (*) die "Usage: $0 up | down | min | max | op pct" ;;
esac
