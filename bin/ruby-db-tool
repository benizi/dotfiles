#!/usr/bin/env ruby
require 'yaml'
require 'erb'
require 'ostruct'

module Adapters
  class Base
    attr_accessor :cfg

    def initialize(cfg)
      self.cfg = OpenStruct.new(cfg)
    end
  end

  class Mysql < Base
    def grant
      <<SQL
create database if not exists `#{cfg.database}`;
grant all privileges on `#{cfg.database}`.* to '#{cfg.username}'@'localhost' identified by "#{cfg.password}";
flush tables;
SQL
    end

    def connect
      %W[mysql -u#{cfg.username} -p#{cfg.password} -hlocalhost -D#{cfg.database}]
    end
  end

  class Postgresql < Base
    def grant
      <<SHELL
sudo su - postgres -c 'createuser '\\''#{cfg.username}'\\'
sudo su - postgres -c 'createdb '\\''#{cfg.database}'\\'' -O #{cfg.username}'
SHELL
    end
  end
end

action = $0 =~ /ruby-db-(\w+)$/ ? $1.to_sym : :connect

if yaml = YAML.load(ERB.new(File.read(ENV['CONFIG'] || 'config/database.yml')).result)
  envs = ENV['ENV'] || ENV['RAILS_ENV'] || 'development'
  envs.split.each do |env|
    cfg = yaml[env]

    if !cfg
      warn "No config for env: #{env}"
      next
    end

    adapter = cfg['adapter']
    unless adapter
      warn "No adapter specified for env: #{env}"
      next
    end

    begin
      adapter_class =
        case adapter
        when 'mysql', 'mysql2' ; then Adapters::Mysql
        when 'postgresql' ; then Adapters::Postgresql
        when 'sqlserver' ; then Adapters::Sqlserver
        else raise NotImplementedError, "Adapter #{adapter} not yet handled"
        end

      handler = adapter_class.new(cfg)
      method = handler.method(action)
      args = method.arity == -1 ? ARGV.clone : []
      ret = method.call(*args)
      if String === ret
        if $stdout.tty? and not defined?($warned)
          warn "(Commands aren't being run -- need to pipe them to something)"
          $warned = true
        end
        puts ret
      elsif Array === ret
        exec(*ret)
      else
        raise NotImplementedError, "Action returned non-string/array"
      end
    rescue NameError
      warn %Q{#{adapter} adapter can't handle "#{action}" action. (env: #{env})}
    rescue NotImplementedError => e
      warn e.message
    end
  end
end
