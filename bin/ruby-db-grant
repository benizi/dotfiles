#!/usr/bin/env ruby
require 'yaml'
require 'erb'

if yaml = YAML.load(ERB.new(File.read(ENV['CONFIG'] || 'config/database.yml')).result)
  envs = ENV['RAILS_ENV'] || ARGV.shift || 'development test'
  envs.split.each do |env|
    cfg = yaml[env]

    if !cfg
      warn "No config for env: #{env}"
      next
    end

    case cfg['adapter']
    when 'mysql', 'mysql2'
      puts <<SQL
create database if not exists `#{cfg['database']}`;
grant all privileges on `#{cfg['database']}`.* to '#{cfg['username']}'@'localhost' identified by "#{cfg['password']}";
flush tables;
SQL
    when 'postgresql'
      puts <<SHELL
sudo su - postgres -c 'createuser '\\''#{cfg['username']}'\\'
sudo su - postgres -c 'createdb '\\''#{cfg['database']}'\\'' -O #{cfg['username']}'
SHELL
    else
      warn "Can't handle adapter #{cfg['adapter']} (env: #{env}) yet"
    end
  end
end
