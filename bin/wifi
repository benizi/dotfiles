#!/bin/zsh
config=$HOME/.config/wifi
unset ssid force
for arg ; do
  case $arg in
    -f|--force) force=true ;;
    *) ssid=$arg ;;
  esac
done
if (( ! $+ssid )) && [[ -f $config ]] ; then
  ssid=$(nmcli dev list | perl -lnwe '
  if ($ARGV eq "-") {
    if (my ($ap, $k, $v) = /^(AP\d+)\.(BSSID|SSID):\s*(.*)$/) {
      $v = eval $v if $v =~ /^\x27/;
      if ($k eq "BSSID") {
        $bs{$ap} = $v;
      } else {
        $ss{$v} = $ap;
      }
    }
  } else {
    $default ||= $_;
    next unless my $ap = $ss{$_};
    print and exit if $bs{$ap} =~ /[^0:]/;
    print $default if eof
  }' - $config)
fi
if (( ! $+force )) && (( $+ssid )) && nmcli con status | grep -q "^$ssid " ; then
  echo alread using $ssid
else
  nmcli con up id $ssid
fi
