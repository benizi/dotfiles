#!/bin/zsh

typeset -a info funcs

add-bat() {
  battery -p
}
funcs+=( add-bat )

add-date() {
  if [[ -f ~/tz ]]
  then date="$(TZ=$(<~/tz) date +'%s %Y-%m-%d %H:%M:%S %Z')"
  else date="$(date +'%s %Y-%m-%d %H:%M:%S')"
  fi
  epoch=${date%% *}
  date=${date#* }
  printf '%s' $date
}
funcs+=( add-date )

add-essid() {
  if (( ! ( epoch % 10 ) )) || (( ! $+essid ))
  then essid="$(essid)"
  fi
  printf '%s' $essid
}
funcs+=( add-essid )

add-mem() {
  awk '
function report(t,f,usecolor){
used = kb(t-f)
color = (usecolor && used) ? "^fg(#ff9900)^ca(1,sudo swapoff -a && sudo swapon -a)" : ""
nocolor = color ? "^fg()^ca()" : ""
return color used "/" kb(t) nocolor
}
function kb(b){return int(b/1024)}
{ stats[$1] = $2 }
END {
printf("mem:%s", report(stats["MemTotal:"], stats["MemFree:"] + stats["Cached:"]))
if (stats["SwapTotal:"]) printf(" swp:%s", report(stats["SwapTotal:"], stats["SwapFree:"], 1))
}
' /proc/meminfo
}
funcs+=( add-mem )

setup() {
  info=()
  for fn in $funcs
  do
    info+=( "$($fn)" )
  done
}

output() {
  printf '%sâ”‚' $info
  printf '\n'
}

while sleep 1
do
  setup
  output
done
