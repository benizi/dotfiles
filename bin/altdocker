#!/bin/sh

set -e +x

# Alter values to taste. These values are appropriate for running a second
# Docker daemon (if the first running daemon uses default values).

: ${altname=altdocker} # basis for names for the alternate daemon
: ${bridge=$altname} # network bridge we'll create
: ${ip=10.100.100.1} # IP address of bridge
: ${prefix=24} # bits in routing prefix
: ${addr=$ip/$prefix} # bridge IP in CIDR notation

: ${base=$HOME/$altname} # base location for filenames
: ${graph=$base/graph} # base location for daemon's storage, etc.
: ${pidfile=$base/pidfile} # PID file location
: ${host=unix://$base/socket} # listening socket (in net.Dial notation)

## Extra options I need:
set -- \
  --dns=$ip \
  --storage-driver=btrfs \
  --exec-opt native.cgroupdriver=cgroupfs \
  "$@"

## Set up alternate network bridge
if ! ip link show $bridge 2> /dev/null | grep -q .
then
  sudo brctl addbr $bridge
  sudo ip addr add $addr dev $bridge
  sudo ip link set dev $bridge up
fi

printf 'To use `docker` without having to specify the host, run:\n'
printf '  export DOCKER_HOST=%s\n' $host

mkdir -p $base
sudo docker daemon \
  --pidfile=$pidfile \
  --bridge=$bridge \
  --graph=$graph \
  --host=$host \
  "$@"
